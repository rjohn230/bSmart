{"version":3,"file":"auth.service.js","sourceRoot":"","sources":["../../../../.ng_build/auth/services/auth.service.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Akveo. All Rights Reserved.\n * Licensed under the MIT License. See License.txt in the project root for license information.\n */\nimport { Inject, Injectable } from '@angular/core';\n\nimport { Observable, of as observableOf } from 'rxjs';\nimport { switchMap, map } from 'rxjs/operators';\n\nimport { NbAuthStrategy } from '../strategies/auth-strategy';\nimport { NB_AUTH_STRATEGIES } from '../auth.options';\nimport { NbAuthResult } from './auth-result';\nimport { NbTokenService } from './token/token.service';\nimport { NbAuthToken } from './token/token';\n\n/**\n * Common authentication service.\n * Should be used to as an interlayer between UI Components and Auth Strategy.\n */\n@Injectable()\nexport class NbAuthService {\n\n  constructor(protected tokenService: NbTokenService,\n              @Inject(NB_AUTH_STRATEGIES) protected strategies) {\n  }\n\n  /**\n   * Retrieves current authenticated token stored\n   * @returns {Observable<any>}\n   */\n  getToken(): Observable<NbAuthToken> {\n    return this.tokenService.get();\n  }\n\n  /**\n   * Returns true if auth token is present in the token storage\n   * @returns {Observable<boolean>}\n   */\n  isAuthenticated(): Observable<boolean> {\n    return this.getToken()\n      .pipe(map((token: NbAuthToken) => token.isValid()));\n  }\n\n  /**\n   * Returns true if valid auth token is present in the token storage.\n   * If not, calls the strategy refreshToken, and returns isAuthenticated() if success, false otherwise\n   * @returns {Observable<boolean>}\n   */\n  isAuthenticatedOrRefresh(): Observable<boolean> {\n    return this.getToken()\n      .pipe(\n        switchMap(token => {\n        if (token.getValue() && !token.isValid()) {\n          return this.refreshToken(token.getOwnerStrategyName(), token)\n            .pipe(\n              switchMap(res => {\n                if (res.isSuccess()) {\n                  return this.isAuthenticated();\n                } else {\n                  return observableOf(false);\n                }\n              }),\n            )\n        } else {\n          return observableOf(token.isValid());\n        }\n    }));\n  }\n\n  /**\n   * Returns tokens stream\n   * @returns {Observable<NbAuthSimpleToken>}\n   */\n  onTokenChange(): Observable<NbAuthToken> {\n    return this.tokenService.tokenChange();\n  }\n\n  /**\n   * Returns authentication status stream\n   * @returns {Observable<boolean>}\n   */\n  onAuthenticationChange(): Observable<boolean> {\n    return this.onTokenChange()\n      .pipe(map((token: NbAuthToken) => token.isValid()));\n  }\n\n  /**\n   * Authenticates with the selected strategy\n   * Stores received token in the token storage\n   *\n   * Example:\n   * authenticate('email', {email: 'email@example.com', password: 'test'})\n   *\n   * @param strategyName\n   * @param data\n   * @returns {Observable<NbAuthResult>}\n   */\n  authenticate(strategyName: string, data?: any): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).authenticate(data)\n      .pipe(\n        switchMap((result: NbAuthResult) => {\n          return this.processResultToken(result);\n        }),\n      );\n  }\n\n  /**\n   * Registers with the selected strategy\n   * Stores received token in the token storage\n   *\n   * Example:\n   * register('email', {email: 'email@example.com', name: 'Some Name', password: 'test'})\n   *\n   * @param strategyName\n   * @param data\n   * @returns {Observable<NbAuthResult>}\n   */\n  register(strategyName: string, data?: any): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).register(data)\n      .pipe(\n        switchMap((result: NbAuthResult) => {\n          return this.processResultToken(result);\n        }),\n      );\n  }\n\n  /**\n   * Sign outs with the selected strategy\n   * Removes token from the token storage\n   *\n   * Example:\n   * logout('email')\n   *\n   * @param strategyName\n   * @returns {Observable<NbAuthResult>}\n   */\n  logout(strategyName: string): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).logout()\n      .pipe(\n        switchMap((result: NbAuthResult) => {\n          if (result.isSuccess()) {\n            this.tokenService.clear()\n              .pipe(map(() => result));\n          }\n          return observableOf(result);\n        }),\n      );\n  }\n\n  /**\n   * Sends forgot password request to the selected strategy\n   *\n   * Example:\n   * requestPassword('email', {email: 'email@example.com'})\n   *\n   * @param strategyName\n   * @param data\n   * @returns {Observable<NbAuthResult>}\n   */\n  requestPassword(strategyName: string, data?: any): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).requestPassword(data);\n  }\n\n  /**\n   * Tries to reset password with the selected strategy\n   *\n   * Example:\n   * resetPassword('email', {newPassword: 'test'})\n   *\n   * @param strategyName\n   * @param data\n   * @returns {Observable<NbAuthResult>}\n   */\n  resetPassword(strategyName: string, data?: any): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).resetPassword(data);\n  }\n\n  /**\n   * Sends a refresh token request\n   * Stores received token in the token storage\n   *\n   * Example:\n   * refreshToken('email', {token: token})\n   *\n   * @param {string} strategyName\n   * @param data\n   * @returns {Observable<NbAuthResult>}\n   */\n  refreshToken(strategyName: string, data?: any): Observable<NbAuthResult> {\n    return this.getStrategy(strategyName).refreshToken(data)\n      .pipe(\n        switchMap((result: NbAuthResult) => {\n          return this.processResultToken(result);\n        }),\n      );\n  }\n\n  /**\n   * Get registered strategy by name\n   *\n   * Example:\n   * getStrategy('email')\n   *\n   * @param {string} provider\n   * @returns {NbAbstractAuthProvider}\n   */\n  protected getStrategy(strategyName: string): NbAuthStrategy {\n    const found = this.strategies.find((strategy: NbAuthStrategy) => strategy.getName() === strategyName);\n\n    if (!found) {\n      throw new TypeError(`There is no Auth Strategy registered under '${strategyName}' name`);\n    }\n\n    return found;\n  }\n\n  private processResultToken(result: NbAuthResult) {\n    if (result.isSuccess() && result.getToken()) {\n      return this.tokenService.set(result.getToken())\n        .pipe(\n          map((token: NbAuthToken) => {\n            return result;\n          }),\n        );\n    }\n\n    return observableOf(result);\n  }\n}\n"]}