{"version":3,"file":"list-page-tracker.directive.js","sourceRoot":"","sources":["../../../../../.ng_build/theme/components/list/list-page-tracker.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Directive,\n  ContentChildren,\n  QueryList,\n  Input,\n  ElementRef,\n  AfterViewInit,\n  OnDestroy,\n  Output,\n  EventEmitter,\n} from '@angular/core';\nimport { takeWhile } from 'rxjs/operators';\nimport 'intersection-observer';\nimport { NbListItemComponent } from './list.component';\n\n/**\n * List pager directive\n *\n * Directive allows you to determine page of currently viewing items.\n *\n */\n@Directive({\n  selector: '[nbListPageTracker]',\n})\nexport class NbListPageTrackerDirective implements AfterViewInit, OnDestroy {\n\n  private alive = true;\n\n  private observer: IntersectionObserver;\n  private currentPage: number;\n\n  /**\n   * Items per page.\n   */\n  @Input()\n  pageSize: number;\n\n  /**\n   * Page to start counting with.\n   */\n  @Input()\n  startPage: number = 1;\n\n  /**\n   * Emits when another page become visible.\n   */\n  @Output()\n  pageChange = new EventEmitter<number>();\n\n  @ContentChildren(NbListItemComponent, { read: ElementRef })\n  listItems: QueryList<ElementRef>;\n\n  constructor() {\n    this.observer = new IntersectionObserver(\n      entries => this.checkForPageChange(entries),\n      { threshold: 0.5 },\n    );\n  }\n\n  ngAfterViewInit() {\n    if (this.listItems && this.listItems.length) {\n      this.observeItems();\n    }\n\n    this.listItems.changes\n      .pipe(takeWhile(() => this.alive))\n      .subscribe(() => this.observeItems());\n  }\n\n  ngOnDestroy() {\n    this.observer.disconnect && this.observer.disconnect();\n  }\n\n  private observeItems() {\n    this.listItems.forEach(i => this.observer.observe(i.nativeElement));\n  }\n\n  private checkForPageChange(entries: IntersectionObserverEntry[]) {\n    const mostVisiblePage = this.findMostVisiblePage(entries);\n\n    if (mostVisiblePage && this.currentPage !== mostVisiblePage) {\n      this.currentPage = mostVisiblePage;\n      this.pageChange.emit(this.currentPage);\n    }\n  }\n\n  private findMostVisiblePage(entries: IntersectionObserverEntry[]): number | null {\n    const intersectionRatioByPage = new Map<number, number>();\n\n    for (const entry of entries) {\n      if (entry.intersectionRatio < 0.5) {\n        continue;\n      }\n\n      const elementIndex = this.elementIndex(entry.target);\n      if (elementIndex === -1) {\n        continue;\n      }\n      const page = this.startPage + Math.floor(elementIndex / this.pageSize);\n\n      let ratio = entry.intersectionRatio;\n      if (intersectionRatioByPage.has(page)) {\n        ratio += intersectionRatioByPage.get(page);\n      }\n      intersectionRatioByPage.set(page, ratio);\n    }\n\n    let maxRatio = 0;\n    let mostVisiblePage;\n    intersectionRatioByPage.forEach((ratio, page) => {\n      if (ratio > maxRatio) {\n        maxRatio = ratio;\n        mostVisiblePage = page;\n      }\n    });\n\n    return mostVisiblePage;\n  }\n\n  private elementIndex(element: Element): number {\n    return element.parentElement && element.parentElement.children\n      ? Array.from(element.parentElement.children).indexOf(element)\n      : -1;\n  }\n}\n"]}