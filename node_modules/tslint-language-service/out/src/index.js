"use strict";
const tslint = require("tslint");
const path = require("path");
//TODO we "steal"" an error code with a registered code fix. 2515 = implement inherited abstract class
const TSLINT_ERROR_CODE = 2515;
function init(modules) {
    const ts = modules.typescript;
    let codeFixActions = new Map();
    let registeredCodeFixes = false;
    let configCache = {
        filePath: null,
        configuration: null,
        isDefaultConfig: false,
        configFilePath: null
    };
    // Work around the lack of API to register a CodeFix
    function registerCodeFix(action) {
        return ts.codefix.registerCodeFix(action);
    }
    if (!registeredCodeFixes && ts && ts.codefix) {
        registerCodeFixes(registerCodeFix);
        registeredCodeFixes = true;
    }
    function registerCodeFixes(registerCodeFix) {
        // Code fix for that is used for all tslint fixes
        registerCodeFix({
            errorCodes: [TSLINT_ERROR_CODE],
            getCodeActions: (_context) => {
                return null;
            }
        });
    }
    function create(info) {
        info.project.projectService.logger.info("tslint-language-service loaded");
        let config = info.config;
        let configuration = null;
        // Set up decorator
        const proxy = Object.create(null);
        const oldLS = info.languageService;
        for (const k in oldLS) {
            proxy[k] = function () {
                return oldLS[k].apply(oldLS, arguments);
            };
        }
        // key to identify a rule failure
        function computeKey(start, end) {
            return `[${start},${end}]`;
        }
        function makeDiagnostic(problem, file) {
            let message = (problem.getRuleName() !== null)
                ? `${problem.getFailure()} (${problem.getRuleName()})`
                : `${problem.getFailure()}`;
            let category;
            if (config.alwaysShowRuleFailuresAsWarnings === true) {
                category = ts.DiagnosticCategory.Warning;
            }
            else if (problem.getRuleSeverity && problem.getRuleSeverity() === 'error') {
                // tslint5 supports to assign severities to rules
                category = ts.DiagnosticCategory.Error;
            }
            else {
                category = ts.DiagnosticCategory.Warning;
            }
            let diagnostic = {
                file: file,
                start: problem.getStartPosition().getPosition(),
                length: problem.getEndPosition().getPosition() - problem.getStartPosition().getPosition(),
                messageText: message,
                category: category,
                source: 'tslint',
                code: TSLINT_ERROR_CODE
            };
            return diagnostic;
        }
        /**
         * Filter failures for the given document
         */
        function filterProblemsForDocument(documentPath, failures) {
            let normalizedPath = path.normalize(documentPath);
            // we only show diagnostics targetting this open document, some tslint rule return diagnostics for other documents/files
            let normalizedFiles = new Map();
            return failures.filter(each => {
                let fileName = each.getFileName();
                if (!normalizedFiles.has(fileName)) {
                    normalizedFiles.set(fileName, path.normalize(fileName));
                }
                return normalizedFiles.get(fileName) === normalizedPath;
            });
        }
        function replacementsAreEmpty(fix) {
            // in tslint 4 a Fix has a replacement property witht the Replacements
            if (fix.replacements) {
                return fix.replacements.length === 0;
            }
            // tslint 5
            if (Array.isArray(fix)) {
                return fix.length === 0;
            }
            return false;
        }
        function recordCodeAction(problem, file) {
            let fix = null;
            // tslint can return a fix with an empty replacements array, these fixes are ignored
            if (problem.getFix && problem.getFix() && !replacementsAreEmpty(problem.getFix())) {
                fix = problem.getFix(); // createAutoFix(problem, document, problem.getFix());
            }
            if (!fix) {
                return;
            }
            let documentAutoFixes = codeFixActions.get(file.fileName);
            if (!documentAutoFixes) {
                documentAutoFixes = new Map();
                codeFixActions.set(file.fileName, documentAutoFixes);
            }
            documentAutoFixes.set(computeKey(problem.getStartPosition().getPosition(), problem.getEndPosition().getPosition()), problem);
        }
        function getConfigurationFailureMessage(err) {
            let errorMessage = `unknown error`;
            if (typeof err.message === 'string' || err.message instanceof String) {
                errorMessage = err.message;
            }
            return `tslint: Cannot read tslint configuration - '${errorMessage}'`;
        }
        function getConfiguration(filePath, configFileName) {
            if (configCache.configuration && configCache.filePath === filePath) {
                return configCache.configuration;
            }
            let isDefaultConfig = false;
            let configuration;
            let configFilePath = null;
            isDefaultConfig = tslint.Configuration.findConfigurationPath(configFileName, filePath) === undefined;
            let configurationResult = tslint.Configuration.findConfiguration(configFileName, filePath);
            // between tslint 4.0.1 and tslint 4.0.2 the attribute 'error' has been removed from IConfigurationLoadResult
            // in 4.0.2 findConfiguration throws an exception as in version ^3.0.0
            if (configurationResult.error) {
                throw configurationResult.error;
            }
            configuration = configurationResult.results;
            // In tslint version 5 the 'no-unused-variable' rules breaks the TypeScript language service plugin.
            // See https://github.com/Microsoft/TypeScript/issues/15344
            // Therefore we remove the rule from the configuration.
            //
            // In tslint 5 the rules are stored in a Map, in earlier versions they were stored in an Object
            if (config.disableNoUnusedVariableRule === true || config.disableNoUnusedVariableRule === undefined) {
                if (configuration.rules && configuration.rules instanceof Map) {
                    configuration.rules.delete('no-unused-variable');
                }
                if (configuration.jsRules && configuration.jsRules instanceof Map) {
                    configuration.jsRules.delete('no-unused-variable');
                }
            }
            configFilePath = configurationResult.path;
            configCache = {
                filePath: filePath,
                isDefaultConfig: isDefaultConfig,
                configuration: configuration,
                configFilePath: configFilePath
            };
            return configCache.configuration;
        }
        function captureWarnings(message) {
            // TODO log to a user visible log and not only the TS-Server log
            info.project.projectService.logger.info(`[tslint] ${message}`);
        }
        function convertReplacementToTextChange(repl) {
            return {
                newText: repl.text,
                span: { start: repl.start, length: repl.length }
            };
        }
        function getReplacements(fix) {
            let replacements = null;
            // in tslint4 a Fix has a replacement property with the Replacements
            if (fix.replacements) {
                // tslint4
                replacements = fix.replacements;
            }
            else {
                // in tslint 5 a Fix is a Replacement | Replacement[]                  
                if (!Array.isArray(fix)) {
                    replacements = [fix];
                }
                else {
                    replacements = fix;
                }
            }
            return replacements;
        }
        function addRuleFailureFix(fixes, problem, fileName) {
            let fix = problem.getFix();
            let replacements = getReplacements(fix);
            fixes.push({
                description: `Fix '${problem.getRuleName()}'`,
                changes: [{
                        fileName: fileName,
                        textChanges: replacements.map(each => convertReplacementToTextChange(each))
                    }]
            });
        }
        function addDisableRuleFix(fixes, problem, fileName, file) {
            fixes.push({
                description: `Disable rule '${problem.getRuleName()}'`,
                changes: [{
                        fileName: fileName,
                        textChanges: [{
                                newText: `// tslint:disable-next-line:${problem.getRuleName()}\n`,
                                span: { start: file.getLineStarts()[problem.getStartPosition().getLineAndCharacter().line], length: 0 }
                            }]
                    }]
            });
        }
        function addOpenConfigurationFix(fixes) {
            // the Open Configuration code action is disabled since there is no specified API to open an editor
            let openConfigFixEnabled = false;
            if (openConfigFixEnabled && configCache && configCache.configFilePath) {
                fixes.push({
                    description: `Open tslint.json`,
                    changes: [{
                            fileName: configCache.configFilePath,
                            textChanges: []
                        }]
                });
            }
        }
        function addAllAutoFixable(fixes, documentFixes, fileName) {
            const allReplacements = getNonOverlappingReplacements(documentFixes);
            fixes.push({
                description: `Fix all auto-fixable tslint failures`,
                changes: [{
                        fileName: fileName,
                        textChanges: allReplacements.map(each => convertReplacementToTextChange(each))
                    }]
            });
        }
        function getReplacement(failure, at) {
            return getReplacements(failure.getFix())[at];
        }
        function sortFailures(failures) {
            // The failures.replacements are sorted by position, we sort on the position of the first replacement
            return failures.sort((a, b) => {
                return getReplacement(a, 0).start - getReplacement(b, 0).start;
            });
        }
        function getNonOverlappingReplacements(documentFixes) {
            function overlaps(a, b) {
                return a.end >= b.start;
            }
            let sortedFailures = sortFailures([...documentFixes.values()]);
            let nonOverlapping = [];
            for (let i = 0; i < sortedFailures.length; i++) {
                let replacements = getReplacements(sortedFailures[i].getFix());
                if (i === 0 || !overlaps(nonOverlapping[nonOverlapping.length - 1], replacements[0])) {
                    nonOverlapping.push(...replacements);
                }
            }
            return nonOverlapping;
        }
        proxy.getSemanticDiagnostics = (fileName) => {
            let prior = oldLS.getSemanticDiagnostics(fileName);
            if (prior === undefined) {
                prior = [];
            }
            try {
                info.project.projectService.logger.info(`Computing tslint semantic diagnostics...`);
                if (codeFixActions.has(fileName)) {
                    codeFixActions.delete(fileName);
                }
                if (config.ignoreDefinitionFiles === true && fileName.endsWith('.d.ts')) {
                    return prior;
                }
                try {
                    configuration = getConfiguration(fileName, config.configFile);
                }
                catch (err) {
                    // TODO: show the reason for the configuration failure to the user and not only in the log
                    // https://github.com/Microsoft/TypeScript/issues/15913
                    info.project.projectService.logger.info(getConfigurationFailureMessage(err));
                    return prior;
                }
                let result;
                // tslint writes warning messages using console.warn()
                // capture the warnings and write them to the tslint plugin log
                let warn = console.warn;
                console.warn = captureWarnings;
                try {
                    // TODO the types of the Program provided by tsserver libary are not compatible with the one provided by typescript
                    // casting away the type
                    let options = { fix: false };
                    let linter = new tslint.Linter(options, oldLS.getProgram());
                    linter.lint(fileName, "", configuration);
                    result = linter.getResult();
                }
                catch (err) {
                    let errorMessage = `unknown error`;
                    if (typeof err.message === 'string' || err.message instanceof String) {
                        errorMessage = err.message;
                    }
                    info.project.projectService.logger.info('tslint error ' + errorMessage);
                    return prior;
                }
                finally {
                    console.warn = warn;
                }
                if (result.failures.length > 0) {
                    const tslintProblems = filterProblemsForDocument(fileName, result.failures);
                    if (tslintProblems && tslintProblems.length) {
                        const file = oldLS.getProgram().getSourceFile(fileName);
                        prior.push.apply(prior, tslintProblems.map(d => makeDiagnostic(d, file)));
                        tslintProblems.forEach(problem => {
                            recordCodeAction(problem, file);
                        });
                    }
                }
            }
            catch (e) {
                info.project.projectService.logger.info(`tslint-language service error: ${e.toString()}`);
                info.project.projectService.logger.info(`Stack trace: ${e.stack}`);
            }
            return prior;
        };
        proxy.getCodeFixesAtPosition = function (fileName, start, end, errorCodes, formatOptions) {
            let prior = oldLS.getCodeFixesAtPosition(fileName, start, end, errorCodes, formatOptions);
            if (prior === undefined) {
                prior = [];
            }
            info.project.projectService.logger.info("tslint-language-service getCodeFixes " + errorCodes[0]);
            let documentFixes = codeFixActions.get(fileName);
            if (documentFixes) {
                let problem = documentFixes.get(computeKey(start, end));
                if (problem) {
                    addRuleFailureFix(prior, problem, fileName);
                }
                addAllAutoFixable(prior, documentFixes, fileName);
                if (problem) {
                    addOpenConfigurationFix(prior);
                    addDisableRuleFix(prior, problem, fileName, oldLS.getProgram().getSourceFile(fileName));
                }
            }
            return prior;
        };
        return proxy;
    }
    return { create };
}
module.exports = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLGlDQUFpQztBQUNqQyw2QkFBNkI7QUFVN0Isc0dBQXNHO0FBQ3RHLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDO0FBRS9CLGNBQWMsT0FBeUM7SUFDbkQsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztJQUU5QixJQUFJLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBMkMsQ0FBQztJQUN4RSxJQUFJLG1CQUFtQixHQUFHLEtBQUssQ0FBQztJQUVoQyxJQUFJLFdBQVcsR0FBRztRQUNkLFFBQVEsRUFBVSxJQUFJO1FBQ3RCLGFBQWEsRUFBTyxJQUFJO1FBQ3hCLGVBQWUsRUFBRSxLQUFLO1FBQ3RCLGNBQWMsRUFBVSxJQUFJO0tBQy9CLENBQUM7SUFFRixvREFBb0Q7SUFDcEQseUJBQXlCLE1BQXVCO1FBQzVDLE1BQU0sQ0FBRSxFQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFLElBQUssRUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDcEQsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDbkMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO0lBQy9CLENBQUM7SUFFRCwyQkFBMkIsZUFBa0Q7UUFDekUsaURBQWlEO1FBQ2pELGVBQWUsQ0FBQztZQUNaLFVBQVUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1lBQy9CLGNBQWMsRUFBRSxDQUFDLFFBQWE7Z0JBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxnQkFBZ0IsSUFBZ0M7UUFFNUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsTUFB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LENBQUMsQ0FBQyxDQUFDO2dCQUM1RixDQUFDO1lBQ0wsQ0FBQztZQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDakIsQ0FBQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDdEIsQ0FBQztBQUVELGlCQUFTLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHRzX21vZHVsZSBmcm9tIFwiLi4vbm9kZV9tb2R1bGVzL3R5cGVzY3JpcHQvbGliL3Rzc2VydmVybGlicmFyeVwiO1xuaW1wb3J0ICogYXMgdHNsaW50IGZyb20gJ3RzbGludCc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG4vLyBTZXR0aW5ncyBmb3IgdGhlIHBsdWdpbiBzZWN0aW9uIGluIHRzY29uZmlnLmpzb25cbmludGVyZmFjZSBTZXR0aW5ncyB7XG4gICAgYWx3YXlzU2hvd1J1bGVGYWlsdXJlc0FzV2FybmluZ3M/OiBib29sZWFuO1xuICAgIGlnbm9yZURlZmluaXRpb25GaWxlcz86IGJvb2xlYW47XG4gICAgY29uZmlnRmlsZT86IHN0cmluZztcbiAgICBkaXNhYmxlTm9VbnVzZWRWYXJpYWJsZVJ1bGU/OiBib29sZWFuICAvLyBzdXBwb3J0IHRvIGVuYWJsZS9kaXNhYmxlIHRoZSB3b3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L1R5cGVTY3JpcHQvaXNzdWVzLzE1MzQ0XG59XG5cbi8vVE9ETyB3ZSBcInN0ZWFsXCJcIiBhbiBlcnJvciBjb2RlIHdpdGggYSByZWdpc3RlcmVkIGNvZGUgZml4LiAyNTE1ID0gaW1wbGVtZW50IGluaGVyaXRlZCBhYnN0cmFjdCBjbGFzc1xuY29uc3QgVFNMSU5UX0VSUk9SX0NPREUgPSAyNTE1O1xuXG5mdW5jdGlvbiBpbml0KG1vZHVsZXM6IHsgdHlwZXNjcmlwdDogdHlwZW9mIHRzX21vZHVsZSB9KSB7XG4gICAgY29uc3QgdHMgPSBtb2R1bGVzLnR5cGVzY3JpcHQ7XG5cbiAgICBsZXQgY29kZUZpeEFjdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgTWFwPHN0cmluZywgdHNsaW50LlJ1bGVGYWlsdXJlPj4oKTtcbiAgICBsZXQgcmVnaXN0ZXJlZENvZGVGaXhlcyA9IGZhbHNlO1xuXG4gICAgbGV0IGNvbmZpZ0NhY2hlID0ge1xuICAgICAgICBmaWxlUGF0aDogPHN0cmluZz5udWxsLFxuICAgICAgICBjb25maWd1cmF0aW9uOiA8YW55Pm51bGwsXG4gICAgICAgIGlzRGVmYXVsdENvbmZpZzogZmFsc2UsXG4gICAgICAgIGNvbmZpZ0ZpbGVQYXRoOiA8c3RyaW5nPm51bGxcbiAgICB9O1xuXG4gICAgLy8gV29yayBhcm91bmQgdGhlIGxhY2sgb2YgQVBJIHRvIHJlZ2lzdGVyIGEgQ29kZUZpeFxuICAgIGZ1bmN0aW9uIHJlZ2lzdGVyQ29kZUZpeChhY3Rpb246IGNvZGVmaXguQ29kZUZpeCkge1xuICAgICAgICByZXR1cm4gKHRzIGFzIGFueSkuY29kZWZpeC5yZWdpc3RlckNvZGVGaXgoYWN0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlZ2lzdGVyZWRDb2RlRml4ZXMgJiYgdHMgJiYgKHRzIGFzIGFueSkuY29kZWZpeCkge1xuICAgICAgICByZWdpc3RlckNvZGVGaXhlcyhyZWdpc3RlckNvZGVGaXgpO1xuICAgICAgICByZWdpc3RlcmVkQ29kZUZpeGVzID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZWdpc3RlckNvZGVGaXhlcyhyZWdpc3RlckNvZGVGaXg6IChhY3Rpb246IGNvZGVmaXguQ29kZUZpeCkgPT4gdm9pZCkge1xuICAgICAgICAvLyBDb2RlIGZpeCBmb3IgdGhhdCBpcyB1c2VkIGZvciBhbGwgdHNsaW50IGZpeGVzXG4gICAgICAgIHJlZ2lzdGVyQ29kZUZpeCh7XG4gICAgICAgICAgICBlcnJvckNvZGVzOiBbVFNMSU5UX0VSUk9SX0NPREVdLFxuICAgICAgICAgICAgZ2V0Q29kZUFjdGlvbnM6IChfY29udGV4dDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNyZWF0ZShpbmZvOiB0cy5zZXJ2ZXIuUGx1Z2luQ3JlYXRlSW5mbykge1xuXG4gICAgICAgIGluZm8ucHJvamVjdC5wcm9qZWN0U2VydmljZS5sb2dnZXIuaW5mbyhcInRzbGludC1sYW5ndWFnZS1zZXJ2aWNlIGxvYWRlZFwiKTtcbiAgICAgICAgbGV0IGNvbmZpZzogU2V0dGluZ3MgPSBpbmZvLmNvbmZpZztcbiAgICAgICAgbGV0IGNvbmZpZ3VyYXRpb246IHRzbGludC5Db25maWd1cmF0aW9uLklDb25maWd1cmF0aW9uRmlsZSA9IG51bGw7XG5cbiAgICAgICAgLy8gU2V0IHVwIGRlY29yYXRvclxuICAgICAgICBjb25zdCBwcm94eSA9IE9iamVjdC5jcmVhdGUobnVsbCkgYXMgdHMuTGFuZ3VhZ2VTZXJ2aWNlO1xuICAgICAgICBjb25zdCBvbGRMUyA9IGluZm8ubGFuZ3VhZ2VTZXJ2aWNlO1xuICAgICAgICBmb3IgKGNvbnN0IGsgaW4gb2xkTFMpIHtcbiAgICAgICAgICAgICg8YW55PnByb3h5KVtrXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKDxhbnk+b2xkTFMpW2tdLmFwcGx5KG9sZExTLCBhcmd1bWVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8ga2V5IHRvIGlkZW50aWZ5IGEgcnVsZSBmYWlsdXJlXG4gICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVLZXkoc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICAgICAgcmV0dXJuIGBbJHtzdGFydH0sJHtlbmR9XWA7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBtYWtlRGlhZ25vc3RpYyhwcm9ibGVtOiB0c2xpbnQuUnVsZUZhaWx1cmUsIGZpbGU6IHRzLlNvdXJjZUZpbGUpOiB0cy5EaWFnbm9zdGljIHtcbiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gKHByb2JsZW0uZ2V0UnVsZU5hbWUoKSAhPT0gbnVsbClcbiAgICAgICAgICAgICAgICA/IGAke3Byb2JsZW0uZ2V0RmFpbHVyZSgpfSAoJHtwcm9ibGVtLmdldFJ1bGVOYW1lKCl9KWBcbiAgICAgICAgICAgICAgICA6IGAke3Byb2JsZW0uZ2V0RmFpbHVyZSgpfWA7XG5cbiAgICAgICAgICAgIGxldCBjYXRlZ29yeTtcbiAgICAgICAgICAgIGlmIChjb25maWcuYWx3YXlzU2hvd1J1bGVGYWlsdXJlc0FzV2FybmluZ3MgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBjYXRlZ29yeSA9IHRzLkRpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nO1xuICAgICAgICAgICAgfSBlbHNlIGlmICgoPGFueT5wcm9ibGVtKS5nZXRSdWxlU2V2ZXJpdHkgJiYgKDxhbnk+cHJvYmxlbSkuZ2V0UnVsZVNldmVyaXR5KCkgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ1IHN1cHBvcnRzIHRvIGFzc2lnbiBzZXZlcml0aWVzIHRvIHJ1bGVzXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnkgPSB0cy5EaWFnbm9zdGljQ2F0ZWdvcnkuRXJyb3I7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhdGVnb3J5ID0gdHMuRGlhZ25vc3RpY0NhdGVnb3J5Lldhcm5pbmc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBkaWFnbm9zdGljOiB0cy5EaWFnbm9zdGljID0ge1xuICAgICAgICAgICAgICAgIGZpbGU6IGZpbGUsXG4gICAgICAgICAgICAgICAgc3RhcnQ6IHByb2JsZW0uZ2V0U3RhcnRQb3NpdGlvbigpLmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgbGVuZ3RoOiBwcm9ibGVtLmdldEVuZFBvc2l0aW9uKCkuZ2V0UG9zaXRpb24oKSAtIHByb2JsZW0uZ2V0U3RhcnRQb3NpdGlvbigpLmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgbWVzc2FnZVRleHQ6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgIHNvdXJjZTogJ3RzbGludCcsXG4gICAgICAgICAgICAgICAgY29kZTogVFNMSU5UX0VSUk9SX0NPREVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gZGlhZ25vc3RpYztcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBGaWx0ZXIgZmFpbHVyZXMgZm9yIHRoZSBnaXZlbiBkb2N1bWVudFxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gZmlsdGVyUHJvYmxlbXNGb3JEb2N1bWVudChkb2N1bWVudFBhdGg6IHN0cmluZywgZmFpbHVyZXM6IHRzbGludC5SdWxlRmFpbHVyZVtdKTogdHNsaW50LlJ1bGVGYWlsdXJlW10ge1xuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRQYXRoID0gcGF0aC5ub3JtYWxpemUoZG9jdW1lbnRQYXRoKTtcbiAgICAgICAgICAgIC8vIHdlIG9ubHkgc2hvdyBkaWFnbm9zdGljcyB0YXJnZXR0aW5nIHRoaXMgb3BlbiBkb2N1bWVudCwgc29tZSB0c2xpbnQgcnVsZSByZXR1cm4gZGlhZ25vc3RpY3MgZm9yIG90aGVyIGRvY3VtZW50cy9maWxlc1xuICAgICAgICAgICAgbGV0IG5vcm1hbGl6ZWRGaWxlcyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gICAgICAgICAgICByZXR1cm4gZmFpbHVyZXMuZmlsdGVyKGVhY2ggPT4ge1xuICAgICAgICAgICAgICAgIGxldCBmaWxlTmFtZSA9IGVhY2guZ2V0RmlsZU5hbWUoKTtcbiAgICAgICAgICAgICAgICBpZiAoIW5vcm1hbGl6ZWRGaWxlcy5oYXMoZmlsZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZWRGaWxlcy5zZXQoZmlsZU5hbWUsIHBhdGgubm9ybWFsaXplKGZpbGVOYW1lKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBub3JtYWxpemVkRmlsZXMuZ2V0KGZpbGVOYW1lKSA9PT0gbm9ybWFsaXplZFBhdGg7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VtZW50c0FyZUVtcHR5KGZpeDogdHNsaW50LkZpeCk6IGJvb2xlYW4ge1xuICAgICAgICAgICAgLy8gaW4gdHNsaW50IDQgYSBGaXggaGFzIGEgcmVwbGFjZW1lbnQgcHJvcGVydHkgd2l0aHQgdGhlIFJlcGxhY2VtZW50c1xuICAgICAgICAgICAgaWYgKCg8YW55PmZpeCkucmVwbGFjZW1lbnRzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICg8YW55PmZpeCkucmVwbGFjZW1lbnRzLmxlbmd0aCA9PT0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIHRzbGludCA1XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmaXgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpeC5sZW5ndGggPT09IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiByZWNvcmRDb2RlQWN0aW9uKHByb2JsZW06IHRzbGludC5SdWxlRmFpbHVyZSwgZmlsZTogdHMuU291cmNlRmlsZSkge1xuICAgICAgICAgICAgbGV0IGZpeDogdHNsaW50LkZpeCA9IG51bGw7XG5cbiAgICAgICAgICAgIC8vIHRzbGludCBjYW4gcmV0dXJuIGEgZml4IHdpdGggYW4gZW1wdHkgcmVwbGFjZW1lbnRzIGFycmF5LCB0aGVzZSBmaXhlcyBhcmUgaWdub3JlZFxuICAgICAgICAgICAgaWYgKHByb2JsZW0uZ2V0Rml4ICYmIHByb2JsZW0uZ2V0Rml4KCkgJiYgIXJlcGxhY2VtZW50c0FyZUVtcHR5KHByb2JsZW0uZ2V0Rml4KCkpKSB7IC8vIHRzbGludCBmaXhlcyBhcmUgbm90IGF2YWlsYWJsZSBpbiB0c2xpbnQgPCAzLjE3XG4gICAgICAgICAgICAgICAgZml4ID0gcHJvYmxlbS5nZXRGaXgoKTsgLy8gY3JlYXRlQXV0b0ZpeChwcm9ibGVtLCBkb2N1bWVudCwgcHJvYmxlbS5nZXRGaXgoKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghZml4KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgZG9jdW1lbnRBdXRvRml4ZXM6IE1hcDxzdHJpbmcsIHRzbGludC5SdWxlRmFpbHVyZT4gPSBjb2RlRml4QWN0aW9ucy5nZXQoZmlsZS5maWxlTmFtZSk7XG4gICAgICAgICAgICBpZiAoIWRvY3VtZW50QXV0b0ZpeGVzKSB7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnRBdXRvRml4ZXMgPSBuZXcgTWFwPHN0cmluZywgdHNsaW50LlJ1bGVGYWlsdXJlPigpO1xuICAgICAgICAgICAgICAgIGNvZGVGaXhBY3Rpb25zLnNldChmaWxlLmZpbGVOYW1lLCBkb2N1bWVudEF1dG9GaXhlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkb2N1bWVudEF1dG9GaXhlcy5zZXQoY29tcHV0ZUtleShwcm9ibGVtLmdldFN0YXJ0UG9zaXRpb24oKS5nZXRQb3NpdGlvbigpLCBwcm9ibGVtLmdldEVuZFBvc2l0aW9uKCkuZ2V0UG9zaXRpb24oKSksIHByb2JsZW0pO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0Q29uZmlndXJhdGlvbkZhaWx1cmVNZXNzYWdlKGVycjogYW55KTogc3RyaW5nIHtcbiAgICAgICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSBgdW5rbm93biBlcnJvcmA7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyB8fCBlcnIubWVzc2FnZSBpbnN0YW5jZW9mIFN0cmluZykge1xuICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IDxzdHJpbmc+ZXJyLm1lc3NhZ2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYHRzbGludDogQ2Fubm90IHJlYWQgdHNsaW50IGNvbmZpZ3VyYXRpb24gLSAnJHtlcnJvck1lc3NhZ2V9J2A7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBnZXRDb25maWd1cmF0aW9uKGZpbGVQYXRoOiBzdHJpbmcsIGNvbmZpZ0ZpbGVOYW1lOiBzdHJpbmcpOiBhbnkge1xuICAgICAgICAgICAgaWYgKGNvbmZpZ0NhY2hlLmNvbmZpZ3VyYXRpb24gJiYgY29uZmlnQ2FjaGUuZmlsZVBhdGggPT09IGZpbGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ0NhY2hlLmNvbmZpZ3VyYXRpb247XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBpc0RlZmF1bHRDb25maWcgPSBmYWxzZTtcbiAgICAgICAgICAgIGxldCBjb25maWd1cmF0aW9uO1xuICAgICAgICAgICAgbGV0IGNvbmZpZ0ZpbGVQYXRoID0gbnVsbDtcblxuICAgICAgICAgICAgaXNEZWZhdWx0Q29uZmlnID0gdHNsaW50LkNvbmZpZ3VyYXRpb24uZmluZENvbmZpZ3VyYXRpb25QYXRoKGNvbmZpZ0ZpbGVOYW1lLCBmaWxlUGF0aCkgPT09IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGxldCBjb25maWd1cmF0aW9uUmVzdWx0ID0gdHNsaW50LkNvbmZpZ3VyYXRpb24uZmluZENvbmZpZ3VyYXRpb24oY29uZmlnRmlsZU5hbWUsIGZpbGVQYXRoKTtcblxuICAgICAgICAgICAgLy8gYmV0d2VlbiB0c2xpbnQgNC4wLjEgYW5kIHRzbGludCA0LjAuMiB0aGUgYXR0cmlidXRlICdlcnJvcicgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIElDb25maWd1cmF0aW9uTG9hZFJlc3VsdFxuICAgICAgICAgICAgLy8gaW4gNC4wLjIgZmluZENvbmZpZ3VyYXRpb24gdGhyb3dzIGFuIGV4Y2VwdGlvbiBhcyBpbiB2ZXJzaW9uIF4zLjAuMFxuICAgICAgICAgICAgaWYgKCg8YW55PmNvbmZpZ3VyYXRpb25SZXN1bHQpLmVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgKDxhbnk+Y29uZmlndXJhdGlvblJlc3VsdCkuZXJyb3I7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25maWd1cmF0aW9uID0gY29uZmlndXJhdGlvblJlc3VsdC5yZXN1bHRzO1xuXG4gICAgICAgICAgICAvLyBJbiB0c2xpbnQgdmVyc2lvbiA1IHRoZSAnbm8tdW51c2VkLXZhcmlhYmxlJyBydWxlcyBicmVha3MgdGhlIFR5cGVTY3JpcHQgbGFuZ3VhZ2Ugc2VydmljZSBwbHVnaW4uXG4gICAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9UeXBlU2NyaXB0L2lzc3Vlcy8xNTM0NFxuICAgICAgICAgICAgLy8gVGhlcmVmb3JlIHdlIHJlbW92ZSB0aGUgcnVsZSBmcm9tIHRoZSBjb25maWd1cmF0aW9uLlxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIC8vIEluIHRzbGludCA1IHRoZSBydWxlcyBhcmUgc3RvcmVkIGluIGEgTWFwLCBpbiBlYXJsaWVyIHZlcnNpb25zIHRoZXkgd2VyZSBzdG9yZWQgaW4gYW4gT2JqZWN0XG4gICAgICAgICAgICBpZiAoY29uZmlnLmRpc2FibGVOb1VudXNlZFZhcmlhYmxlUnVsZSA9PT0gdHJ1ZSB8fCBjb25maWcuZGlzYWJsZU5vVW51c2VkVmFyaWFibGVSdWxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAoY29uZmlndXJhdGlvbi5ydWxlcyAmJiBjb25maWd1cmF0aW9uLnJ1bGVzIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucnVsZXMuZGVsZXRlKCduby11bnVzZWQtdmFyaWFibGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNvbmZpZ3VyYXRpb24uanNSdWxlcyAmJiBjb25maWd1cmF0aW9uLmpzUnVsZXMgaW5zdGFuY2VvZiBNYXApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5qc1J1bGVzLmRlbGV0ZSgnbm8tdW51c2VkLXZhcmlhYmxlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25maWdGaWxlUGF0aCA9IGNvbmZpZ3VyYXRpb25SZXN1bHQucGF0aDtcblxuICAgICAgICAgICAgY29uZmlnQ2FjaGUgPSB7XG4gICAgICAgICAgICAgICAgZmlsZVBhdGg6IGZpbGVQYXRoLFxuICAgICAgICAgICAgICAgIGlzRGVmYXVsdENvbmZpZzogaXNEZWZhdWx0Q29uZmlnLFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb246IGNvbmZpZ3VyYXRpb24sXG4gICAgICAgICAgICAgICAgY29uZmlnRmlsZVBhdGg6IGNvbmZpZ0ZpbGVQYXRoXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ0NhY2hlLmNvbmZpZ3VyYXRpb247XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGZ1bmN0aW9uIGNhcHR1cmVXYXJuaW5ncyhtZXNzYWdlPzogYW55KTogdm9pZCB7XG4gICAgICAgICAgICAvLyBUT0RPIGxvZyB0byBhIHVzZXIgdmlzaWJsZSBsb2cgYW5kIG5vdCBvbmx5IHRoZSBUUy1TZXJ2ZXIgbG9nXG4gICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oYFt0c2xpbnRdICR7bWVzc2FnZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGNvbnZlcnRSZXBsYWNlbWVudFRvVGV4dENoYW5nZShyZXBsOiB0c2xpbnQuUmVwbGFjZW1lbnQpOiB0cy5UZXh0Q2hhbmdlIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmV3VGV4dDogcmVwbC50ZXh0LFxuICAgICAgICAgICAgICAgIHNwYW46IHsgc3RhcnQ6IHJlcGwuc3RhcnQsIGxlbmd0aDogcmVwbC5sZW5ndGggfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZnVuY3Rpb24gZ2V0UmVwbGFjZW1lbnRzKGZpeDogdHNsaW50LkZpeCk6IHRzbGludC5SZXBsYWNlbWVudFtde1xuICAgICAgICAgICAgbGV0IHJlcGxhY2VtZW50czogdHNsaW50LlJlcGxhY2VtZW50W10gPSBudWxsO1xuICAgICAgICAgICAgLy8gaW4gdHNsaW50NCBhIEZpeCBoYXMgYSByZXBsYWNlbWVudCBwcm9wZXJ0eSB3aXRoIHRoZSBSZXBsYWNlbWVudHNcbiAgICAgICAgICAgIGlmICgoPGFueT5maXgpLnJlcGxhY2VtZW50cykge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDRcbiAgICAgICAgICAgICAgICByZXBsYWNlbWVudHMgPSAoPGFueT5maXgpLnJlcGxhY2VtZW50cztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gaW4gdHNsaW50IDUgYSBGaXggaXMgYSBSZXBsYWNlbWVudCB8IFJlcGxhY2VtZW50W10gICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZml4KSkge1xuICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudHMgPSBbPGFueT5maXhdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VtZW50cyA9IGZpeDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnRzO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gYWRkUnVsZUZhaWx1cmVGaXgoZml4ZXM6IHRzX21vZHVsZS5Db2RlQWN0aW9uW10sIHByb2JsZW06IHRzbGludC5SdWxlRmFpbHVyZSwgZmlsZU5hbWU6IHN0cmluZykge1xuICAgICAgICAgICAgbGV0IGZpeCA9IHByb2JsZW0uZ2V0Rml4KCk7XG4gICAgICAgICAgICBsZXQgcmVwbGFjZW1lbnRzOiB0c2xpbnQuUmVwbGFjZW1lbnRbXSA9IGdldFJlcGxhY2VtZW50cyhmaXgpO1xuXG4gICAgICAgICAgICBmaXhlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYEZpeCAnJHtwcm9ibGVtLmdldFJ1bGVOYW1lKCl9J2AsXG4gICAgICAgICAgICAgICAgY2hhbmdlczogW3tcbiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICB0ZXh0Q2hhbmdlczogcmVwbGFjZW1lbnRzLm1hcChlYWNoID0+IGNvbnZlcnRSZXBsYWNlbWVudFRvVGV4dENoYW5nZShlYWNoKSlcbiAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgfSk7ICBcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGFkZERpc2FibGVSdWxlRml4KGZpeGVzOiB0c19tb2R1bGUuQ29kZUFjdGlvbltdLCBwcm9ibGVtOiB0c2xpbnQuUnVsZUZhaWx1cmUsIGZpbGVOYW1lOiBzdHJpbmcsIGZpbGU6IHRzX21vZHVsZS5Tb3VyY2VGaWxlKSB7XG4gICAgICAgICAgICBmaXhlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYERpc2FibGUgcnVsZSAnJHtwcm9ibGVtLmdldFJ1bGVOYW1lKCl9J2AsXG4gICAgICAgICAgICAgICAgY2hhbmdlczogW3tcbiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICB0ZXh0Q2hhbmdlczogW3tcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RleHQ6IGAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6JHtwcm9ibGVtLmdldFJ1bGVOYW1lKCl9XFxuYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW46IHsgc3RhcnQ6IGZpbGUuZ2V0TGluZVN0YXJ0cygpW3Byb2JsZW0uZ2V0U3RhcnRQb3NpdGlvbigpLmdldExpbmVBbmRDaGFyYWN0ZXIoKS5saW5lXSwgbGVuZ3RoOiAwIH1cbiAgICAgICAgICAgICAgICAgICAgfV1cbiAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBhZGRPcGVuQ29uZmlndXJhdGlvbkZpeChmaXhlczogdHNfbW9kdWxlLkNvZGVBY3Rpb25bXSkge1xuICAgICAgICAgICAgLy8gdGhlIE9wZW4gQ29uZmlndXJhdGlvbiBjb2RlIGFjdGlvbiBpcyBkaXNhYmxlZCBzaW5jZSB0aGVyZSBpcyBubyBzcGVjaWZpZWQgQVBJIHRvIG9wZW4gYW4gZWRpdG9yXG4gICAgICAgICAgICBsZXQgb3BlbkNvbmZpZ0ZpeEVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChvcGVuQ29uZmlnRml4RW5hYmxlZCAmJiBjb25maWdDYWNoZSAmJiBjb25maWdDYWNoZS5jb25maWdGaWxlUGF0aCkge1xuICAgICAgICAgICAgICAgIGZpeGVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYE9wZW4gdHNsaW50Lmpzb25gLFxuICAgICAgICAgICAgICAgICAgICBjaGFuZ2VzOiBbe1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGNvbmZpZ0NhY2hlLmNvbmZpZ0ZpbGVQYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dENoYW5nZXM6IFtdXG4gICAgICAgICAgICAgICAgICAgIH1dXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBhZGRBbGxBdXRvRml4YWJsZShmaXhlczogdHNfbW9kdWxlLkNvZGVBY3Rpb25bXSwgZG9jdW1lbnRGaXhlczogTWFwPHN0cmluZywgdHNsaW50LlJ1bGVGYWlsdXJlPiwgZmlsZU5hbWU6IHN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgYWxsUmVwbGFjZW1lbnRzID0gZ2V0Tm9uT3ZlcmxhcHBpbmdSZXBsYWNlbWVudHMoZG9jdW1lbnRGaXhlcyk7XG4gICAgICAgICAgICBmaXhlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogYEZpeCBhbGwgYXV0by1maXhhYmxlIHRzbGludCBmYWlsdXJlc2AsXG4gICAgICAgICAgICAgICAgY2hhbmdlczogW3tcbiAgICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICB0ZXh0Q2hhbmdlczogYWxsUmVwbGFjZW1lbnRzLm1hcChlYWNoID0+IGNvbnZlcnRSZXBsYWNlbWVudFRvVGV4dENoYW5nZShlYWNoKSlcbiAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgfSk7IFxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gZ2V0UmVwbGFjZW1lbnQoZmFpbHVyZTogdHNsaW50LlJ1bGVGYWlsdXJlLCBhdDpudW1iZXIpOiB0c2xpbnQuUmVwbGFjZW1lbnQge1xuICAgICAgICAgICAgcmV0dXJuIGdldFJlcGxhY2VtZW50cyhmYWlsdXJlLmdldEZpeCgpKVthdF07XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBzb3J0RmFpbHVyZXMoZmFpbHVyZXM6IHRzbGludC5SdWxlRmFpbHVyZVtdKTp0c2xpbnQuUnVsZUZhaWx1cmVbXSB7XG5cdCAgICAgICAgLy8gVGhlIGZhaWx1cmVzLnJlcGxhY2VtZW50cyBhcmUgc29ydGVkIGJ5IHBvc2l0aW9uLCB3ZSBzb3J0IG9uIHRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcmVwbGFjZW1lbnRcbiAgICAgICAgICAgIHJldHVybiBmYWlsdXJlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdldFJlcGxhY2VtZW50KGEsIDApLnN0YXJ0IC0gZ2V0UmVwbGFjZW1lbnQoYiwgMCkuc3RhcnQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGdldE5vbk92ZXJsYXBwaW5nUmVwbGFjZW1lbnRzKGRvY3VtZW50Rml4ZXM6IE1hcDxzdHJpbmcsIHRzbGludC5SdWxlRmFpbHVyZT4pOiB0c2xpbnQuUmVwbGFjZW1lbnRbXSB7XG4gICAgICAgICAgICBmdW5jdGlvbiBvdmVybGFwcyhhOiB0c2xpbnQuUmVwbGFjZW1lbnQsIGI6IHRzbGludC5SZXBsYWNlbWVudCk6IGJvb2xlYW4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBhLmVuZCA+PSBiLnN0YXJ0O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgc29ydGVkRmFpbHVyZXMgPSBzb3J0RmFpbHVyZXMoWy4uLmRvY3VtZW50Rml4ZXMudmFsdWVzKCldKTtcbiAgICAgICAgICAgIGxldCBub25PdmVybGFwcGluZzogdHNsaW50LlJlcGxhY2VtZW50W10gPSBbXTtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydGVkRmFpbHVyZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVwbGFjZW1lbnRzID0gZ2V0UmVwbGFjZW1lbnRzKHNvcnRlZEZhaWx1cmVzW2ldLmdldEZpeCgpKTtcbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCB8fCAhb3ZlcmxhcHMobm9uT3ZlcmxhcHBpbmdbbm9uT3ZlcmxhcHBpbmcubGVuZ3RoIC0gMV0sIHJlcGxhY2VtZW50c1swXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9uT3ZlcmxhcHBpbmcucHVzaCguLi5yZXBsYWNlbWVudHMpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG5vbk92ZXJsYXBwaW5nO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJveHkuZ2V0U2VtYW50aWNEaWFnbm9zdGljcyA9IChmaWxlTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBsZXQgcHJpb3IgPSBvbGRMUy5nZXRTZW1hbnRpY0RpYWdub3N0aWNzKGZpbGVOYW1lKTtcbiAgICAgICAgICAgIGlmIChwcmlvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcHJpb3IgPSBbXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oYENvbXB1dGluZyB0c2xpbnQgc2VtYW50aWMgZGlhZ25vc3RpY3MuLi5gKTtcbiAgICAgICAgICAgICAgICBpZiAoY29kZUZpeEFjdGlvbnMuaGFzKGZpbGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBjb2RlRml4QWN0aW9ucy5kZWxldGUoZmlsZU5hbWUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChjb25maWcuaWdub3JlRGVmaW5pdGlvbkZpbGVzID09PSB0cnVlICYmIGZpbGVOYW1lLmVuZHNXaXRoKCcuZC50cycpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmlvcjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uID0gZ2V0Q29uZmlndXJhdGlvbihmaWxlTmFtZSwgY29uZmlnLmNvbmZpZ0ZpbGUpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBzaG93IHRoZSByZWFzb24gZm9yIHRoZSBjb25maWd1cmF0aW9uIGZhaWx1cmUgdG8gdGhlIHVzZXIgYW5kIG5vdCBvbmx5IGluIHRoZSBsb2dcbiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9UeXBlU2NyaXB0L2lzc3Vlcy8xNTkxM1xuICAgICAgICAgICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oZ2V0Q29uZmlndXJhdGlvbkZhaWx1cmVNZXNzYWdlKGVycikpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwcmlvcjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0OiB0c2xpbnQuTGludFJlc3VsdDtcblxuICAgICAgICAgICAgICAgIC8vIHRzbGludCB3cml0ZXMgd2FybmluZyBtZXNzYWdlcyB1c2luZyBjb25zb2xlLndhcm4oKVxuICAgICAgICAgICAgICAgIC8vIGNhcHR1cmUgdGhlIHdhcm5pbmdzIGFuZCB3cml0ZSB0aGVtIHRvIHRoZSB0c2xpbnQgcGx1Z2luIGxvZ1xuICAgICAgICAgICAgICAgIGxldCB3YXJuID0gY29uc29sZS53YXJuO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybiA9IGNhcHR1cmVXYXJuaW5ncztcblxuICAgICAgICAgICAgICAgIHRyeSB7IC8vIHByb3RlY3QgYWdhaW5zdCB0c2xpbnQgY3Jhc2hlc1xuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIHRoZSB0eXBlcyBvZiB0aGUgUHJvZ3JhbSBwcm92aWRlZCBieSB0c3NlcnZlciBsaWJhcnkgYXJlIG5vdCBjb21wYXRpYmxlIHdpdGggdGhlIG9uZSBwcm92aWRlZCBieSB0eXBlc2NyaXB0XG4gICAgICAgICAgICAgICAgICAgIC8vIGNhc3RpbmcgYXdheSB0aGUgdHlwZVxuICAgICAgICAgICAgICAgICAgICBsZXQgb3B0aW9uczogdHNsaW50LklMaW50ZXJPcHRpb25zID0geyBmaXg6IGZhbHNlIH07XG4gICAgICAgICAgICAgICAgICAgIGxldCBsaW50ZXIgPSBuZXcgdHNsaW50LkxpbnRlcihvcHRpb25zLCA8YW55Pm9sZExTLmdldFByb2dyYW0oKSk7XG4gICAgICAgICAgICAgICAgICAgIGxpbnRlci5saW50KGZpbGVOYW1lLCBcIlwiLCBjb25maWd1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbGludGVyLmdldFJlc3VsdCgpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gYHVua25vd24gZXJyb3JgO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyB8fCBlcnIubWVzc2FnZSBpbnN0YW5jZW9mIFN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gPHN0cmluZz5lcnIubWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oJ3RzbGludCBlcnJvciAnICsgZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByaW9yO1xuICAgICAgICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybiA9IHdhcm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5mYWlsdXJlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRzbGludFByb2JsZW1zID0gZmlsdGVyUHJvYmxlbXNGb3JEb2N1bWVudChmaWxlTmFtZSwgcmVzdWx0LmZhaWx1cmVzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRzbGludFByb2JsZW1zICYmIHRzbGludFByb2JsZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZSA9IG9sZExTLmdldFByb2dyYW0oKS5nZXRTb3VyY2VGaWxlKGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByaW9yLnB1c2guYXBwbHkocHJpb3IsIHRzbGludFByb2JsZW1zLm1hcChkID0+IG1ha2VEaWFnbm9zdGljKGQsIGZpbGUpKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0c2xpbnRQcm9ibGVtcy5mb3JFYWNoKHByb2JsZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZENvZGVBY3Rpb24ocHJvYmxlbSwgZmlsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oYHRzbGludC1sYW5ndWFnZSBzZXJ2aWNlIGVycm9yOiAke2UudG9TdHJpbmcoKX1gKTtcbiAgICAgICAgICAgICAgICBpbmZvLnByb2plY3QucHJvamVjdFNlcnZpY2UubG9nZ2VyLmluZm8oYFN0YWNrIHRyYWNlOiAke2Uuc3RhY2t9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJpb3I7XG4gICAgICAgIH07XG5cbiAgICAgICAgcHJveHkuZ2V0Q29kZUZpeGVzQXRQb3NpdGlvbiA9IGZ1bmN0aW9uIChmaWxlTmFtZTogc3RyaW5nLCBzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgZXJyb3JDb2RlczogbnVtYmVyW10sIGZvcm1hdE9wdGlvbnM6IHRzLkZvcm1hdENvZGVTZXR0aW5ncyk6IHRzLkNvZGVBY3Rpb25bXSB7XG4gICAgICAgICAgICBsZXQgcHJpb3IgPSBvbGRMUy5nZXRDb2RlRml4ZXNBdFBvc2l0aW9uKGZpbGVOYW1lLCBzdGFydCwgZW5kLCBlcnJvckNvZGVzLCBmb3JtYXRPcHRpb25zKTtcbiAgICAgICAgICAgIGlmIChwcmlvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcHJpb3IgPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluZm8ucHJvamVjdC5wcm9qZWN0U2VydmljZS5sb2dnZXIuaW5mbyhcInRzbGludC1sYW5ndWFnZS1zZXJ2aWNlIGdldENvZGVGaXhlcyBcIiArIGVycm9yQ29kZXNbMF0pO1xuICAgICAgICAgICAgbGV0IGRvY3VtZW50Rml4ZXMgPSBjb2RlRml4QWN0aW9ucy5nZXQoZmlsZU5hbWUpO1xuXG4gICAgICAgICAgICBpZiAoZG9jdW1lbnRGaXhlcykge1xuICAgICAgICAgICAgICAgIGxldCBwcm9ibGVtID0gZG9jdW1lbnRGaXhlcy5nZXQoY29tcHV0ZUtleShzdGFydCwgZW5kKSk7XG4gICAgICAgICAgICAgICAgaWYgKHByb2JsZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkUnVsZUZhaWx1cmVGaXgocHJpb3IsIHByb2JsZW0sIGZpbGVOYW1lKTsgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhZGRBbGxBdXRvRml4YWJsZShwcmlvciwgZG9jdW1lbnRGaXhlcywgZmlsZU5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChwcm9ibGVtKSB7XG4gICAgICAgICAgICAgICAgICAgIGFkZE9wZW5Db25maWd1cmF0aW9uRml4KHByaW9yKTtcbiAgICAgICAgICAgICAgICAgICAgYWRkRGlzYWJsZVJ1bGVGaXgocHJpb3IsIHByb2JsZW0sIGZpbGVOYW1lLCBvbGRMUy5nZXRQcm9ncmFtKCkuZ2V0U291cmNlRmlsZShmaWxlTmFtZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmlvcjtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHByb3h5O1xuICAgIH1cblxuICAgIHJldHVybiB7IGNyZWF0ZSB9O1xufVxuXG5leHBvcnQgPSBpbml0O1xuXG4vKiBAaW50ZXJuYWwgKi9cbi8vIHdvcmsgYXJvdW5kIGZvciBtaXNzaW5nIEFQSSB0byByZWdpc3RlciBhIGNvZGUgZml4XG5uYW1lc3BhY2UgY29kZWZpeCB7XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIENvZGVGaXgge1xuICAgICAgICBlcnJvckNvZGVzOiBudW1iZXJbXTtcbiAgICAgICAgZ2V0Q29kZUFjdGlvbnMoY29udGV4dDogYW55KTogdHMuQ29kZUFjdGlvbltdIHwgdW5kZWZpbmVkO1xuICAgIH1cbn0iXX0=